worker_processes 1;
events { worker_connections 1024; }

http {
  # DNS-Resolver, damit $geoserver_host aufgelöst wird
  resolver 1.1.1.1 8.8.8.8 ipv6=off;

  # Origin zurückspiegeln (oder "*" beibehalten)
  map $http_origin $allow_origin { default "*"; "~^https?://.*" $http_origin; }

  server {
    listen 8080;

    # CORS-Header (inkl. Preflight)
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Headers * always;
    add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,HEAD,OPTIONS" always;
    if ($request_method = OPTIONS) { return 204; }

    # === WICHTIG: deine GeoServer-Domain ===
    set $geoserver_host "geoserver-production-7fb4.up.railway.app";

    #  Healthcheck
    location = / { return 200 "nginx cors proxy ok\n"; add_header Content-Type text/plain; }

    # Proxy: Pfad bleibt unverändert -> /geoserver/... wird 1:1 weitergereicht
    location /geoserver/ {
      proxy_pass https://$geoserver_host;      # KEIN zusätzlicher Pfad anhängen!
      proxy_set_header Host $geoserver_host;   # Host-Header auf Upstream setzen
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_ssl_server_name on;                # SNI für HTTPS
      proxy_redirect off;
    }
  }
}
